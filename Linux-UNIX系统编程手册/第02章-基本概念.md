# 第2章 基本概念

## 2.1 操作系统核心-内核

内核为管理计算机系统提供了软件抽象: 进程调度，内存管理，文件系统，网络接口

应用程序视角 vs 内核视角


## 2.2 Shell

login shell是指用户登录系统时，由系统创建，用以运行Shell的进程, 并且集成于内核中
- Bourne Shell(sh): UNIX第七版标配的shell
- Bourne again Shell(bash): 是GNU项目针对Bourne Shell的重新实现, Linux上的Bourne Shell(sh)实际上是由bash仿真提供的


## 2.3 用户和组

- `/etc/passwd` 目录: `wz:x:1000:1000:wz,,,:/home/wz:/bin/bash` 包含用户名，用户uid,组gid,主目录和登录shell
- 密码在`/etc/shadow` 中， 通过MD5加密存放
- 组信息在`/etc/group`中， 一个用户可以存在于多个组, 一个组可以包含多个用户
- 超级用户uid为0，登录名为root


## 2.4 目录与文件

- 文件类型: 普通文件，目录，设备，管道，套接字，符号链接
- 每个文件包含用户ID,组ID，其他用户的读写执行rwx的权限位, 可以通过chmod +x 添加权限


## 2.5 文件IO模型

UNIX系统的everything is file, 包括设备文件

通过open read write close等系统调用执行I/O操作，针对于所有文件, 本质而言内核只提供一种文件类型：字节流序列, 通过lseek()系统调用进行随机访问

文件描述符:
- Linux进程通过系统调用open使用获取文件描述符来指代打开的文件
- 拿到一个文件描述符都可以进行read或者write。但是具体的read和write却跟对应文件描述符的具体实现不同。比如socket的就是走网络，普通文件的就是走磁盘IO
- 由shell启动的进程继承3个已经打开的文件描述符, 0/1/2标准输入/标准输出/标准错误输出, 在stdio库函数中分别与流stdin/stdout/stderr对应


## 2.6 程序

程序经过编译和处理，转换为二进制机器码
- 过滤器: 从stdin读输入， 加以转换，将数据输出到stdout的程序称为过滤器，例如cat/grep/wc/sed/awk等
- 命令行参数`int main(int argc, char *argv[]);` 其中字符串argv[0]表示程序名本身


## 2.7 进程

进程包括代码段，数据段，堆，栈等

进程的创建通过fork，然后子进程可以通过execve加载一个新的程序

进程标识符PID和父进程标识符PPID

进程终止：通过_exit系统调用请求退出, 或者向进程传递信号, 进程终止状态保存在shell变量`$?`中

每个进程都有相关的用户UID和组GID：真实UID和GID, 有效UID和GID, 补充组ID

init进程是所有用户进程的祖先 `/sbin/init`, PID=1,并且以超级用户权限运行，因此都无法杀死init进程，除了系统关机

守护进程在后台运行，一般在系统引导时启动，例如syslogd(记录系统日志)和httpd(http分发页面)

环境列表: fork创建新进程后子进程会继承父进程的环境变量表, 可以通过export命令创建环境变量，C语言中通过外部变量char **environ引用环境变量列表

资源限制：通过fork创建的新进程会继承父进程对资源的限制，可以通过ulimit命令调整shell的资源限制



## 2.8 内存映射

mmap系统调用可以在进程的地址空间创建新的内存映射：包括文件映射和匿名映射
- 文件映射是两个进程对某一个文件的相同部分加一映射，映射页面按序从文件中加载
- 匿名映射：没有文件对应，映射页面被初始化为0

mmap可以用于初始化文本段，内存分配，文件IO映射，以及共享内存用于进程间通信



## 2.9 静态库和动态库


## 2.10 进程间通信与同步

进程间通信机制 IPC
- 管道: pipe, `int pipe(int filedes[2]);` 其中fd[0]固定用于读管道，而fd[1]固定用于写管道, fork之后子进程会继承这些文件描述符，因此可以在子进程之间传递信息, 通过虚拟文件系统实现, 内核中的打开文件表指向一个物理页面实现
- 命名管道: fifo - first-in first-out special file, named pipe, `int mkfifo(const char *filename, mode_t mode);` 通过管道名实现没有父子关系的进程间通信，双方通过filename进行普通文件的write和read操作进行通信，会在文件系统上创建一个管道文件
- 信号: signal机制, Linux大概有31种信号
- 套接字: socket实现网络中的IPC
- 消息队列：用于进程间交换信息
- 信号量: semaphore, 同步进程
- 共享内存：允许两个以上进程进程共享一块内存，进行通信


## 2.11 信号

man 7 signal

信号机制也称为软件中断，内核、其他进程或者进程自身可以向进程发送信号

内核向进程发送信号: 子进程终止，用户键入Ctrl+C, 时钟到期，进程访问无效内存地址

shell向进程发送信号: kill命令发送信号

进程收到信号的处理:
- 忽略该信号
- 被信号杀死结束进程
- 挂起，等待其他信号的唤醒
- 信号处理函数


## 2.12 线程

## 2.13 进程组

`$ ls -l | sort -k5n | less` 会由shell进程创建3个子进程执行管道命令

## 2.14 会话

## 2.15 伪终端

通过网络输入实现PIC通信， 例如telnet和ssh以及 X Window

## 2.16 时间和日期

## 2.17 客户端/服务器架构

## 2.18 实时性

## 2.19 /proc文件系统

/proc文件系统是一种虚拟文件系统， 以文件和目录形式指向内核数据结构的接口，为查看内核属性提供窗口

通过`/proc/${PID}`查看进程ID的各种相关信息







